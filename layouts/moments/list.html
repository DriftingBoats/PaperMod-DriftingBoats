{{ define "main" }}

    <!-- å¦‚æœéœ€è¦å¼•å…¥ moments.cssï¼Œè¯·ä¿æŒè·¯å¾„ä¸€è‡´æˆ–æ ¹æ®è‡ªå·±é¡¹ç›®ç»“æ„è°ƒæ•´ -->
    {{ $css := resources.Get "css/extended/moments.css" | minify | fingerprint }}
    <link
        crossorigin="anonymous"
        href="{{ $css.RelPermalink }}"
        integrity="{{ $css.Data.Integrity }}"
        rel="stylesheet"
    />

    {{ $dateformat := .Params.DateFormat }}

    <article class="post-single">
        <header class="page-header">
            <!-- å¯æ ¹æ®éœ€æ±‚æ·»åŠ é¡µé¢æ ‡é¢˜ã€æè¿°ç­‰ -->
            <!-- <h1>{{ .Title }}</h1> -->
        </header>

        <div class="tags-filter">
            <ul>
                <li><a href="#" class="tag-filter all-tags">å…¨éƒ¨</a></li> <!-- "å…¨éƒ¨"é€‰é¡¹ -->
                {{ $tags := slice }} <!-- ç”¨äºå­˜å‚¨æ‰€æœ‰æ ‡ç­¾ -->
                
                {{ range .Pages }}
                    {{ range .Params.tags }}
                        {{ if not (in $tags .) }}
                            {{ $tags = $tags | append . }}
                        {{ end }}
                    {{ end }}
                {{ end }}
        
                <!-- æŒ‰å­—æ¯é¡ºåºæ’åºæ ‡ç­¾ -->
                {{ $tags = $tags | sort }}
        
                {{ range $tags }}
                    <li><a href="#" class="tag-filter">{{ . }}</a></li> <!-- æ ‡ç­¾é¡¹ -->
                {{ end }}
            </ul>
        </div>        
         
        <div class="post-content">
            <div class="moments-list">
                {{ range .Pages }}
                    {{ if .Content }}
                        <!-- å¡ç‰‡å®¹å™¨ -->
                        <div class="moment-card">
                            <!-- å¤´éƒ¨ï¼šå¤´åƒ + ä½œè€…å -->
                            <div class="moment-header">
                                <div class="left-content">
                                    <img
                                        src="{{ site.Params.label.avatar }}"
                                        alt="{{ site.Params.author }}"
                                        class="moment-avatar"
                                    >
                                    <span class="moment-author">
                                        {{ site.Params.author }}
                                    </span>
                                </div>
                            </div>

                            <!-- åŠ¨æ€ä¸»ä½“å†…å®¹ï¼ˆHugo æ¸²æŸ“åçš„ .Contentï¼‰ -->
                            <div class="moment-body">
                                <div class="moment-content-wrapper">
                                    {{ .Content | safeHTML }}
                                </div>
                                <div class="moment-loading">
                                    <div class="loading-spinner"></div>
                                    <div class="skeleton-content">
                                        <div class="skeleton-line" style="width: 90%"></div>
                                        <div class="skeleton-line" style="width: 75%"></div>
                                        <div class="skeleton-line" style="width: 60%"></div>
                                    </div>
                                </div>
                                <div class="moment-error" style="display: none;">
                                    <span>å›¾ç‰‡åŠ è½½å¤±è´¥</span>
                                    <button onclick="retryLoad(this)">é‡è¯•</button>
                                </div>
                            </div>

                            <!-- æ ‡ç­¾ï¼ˆå¦‚æœæœ‰ï¼‰ -->
                            {{ if .Params.tags }}
                                <div class="moment-tags">
                                    {{ range $tag := .Params.tags }}
                                        <span class="moment-tag">{{ $tag }}</span>
                                    {{ end }}
                                </div>
                            {{ end }}

                            <!-- åº•éƒ¨ï¼šæ—¶é—´ + è¯„è®ºæŒ‰é’® -->
                            <div class="moment-bottom">
                                <div class="moment-time">
                                    <span>
                                        {{ .Param "date" | time.Format (default site.Params.DateFormat $dateformat) }}
                                    </span>
                                </div>
                                <!-- å¦‚æœæ²¡æœ‰ hideComment å‚æ•°ï¼Œåˆ™æ˜¾ç¤ºè¯„è®ºæŒ‰é’® -->
                                {{ if not (.Param "hideComment") }}
                                <button
                                    class="moment-comment-btn"
                                    onclick="showComment(this)"
                                    data-slug="{{ .Param "slug" }}"
                                    data-path="{{ .Param "slug" }}"
                                >
                                    <!-- è¯„è®ºå›¾æ ‡ SVG -->
                                    <svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"><path d="M281.535354 387.361616c-31.806061 0-57.664646 26.763636-57.664647 59.733333 0 32.969697 25.858586 59.733333 57.664647 59.733334s57.664646-26.763636 57.664646-59.733334c0-33.09899-25.858586-59.733333-57.664646-59.733333z m230.529292 0c-31.806061 0-57.664646 26.763636-57.664646 59.733333 0 32.969697 25.729293 59.733333 57.664646 59.733334 31.806061 0 57.535354-26.763636 57.535354-59.733334 0-33.09899-25.858586-59.733333-57.535354-59.733333z m230.4 0c-31.806061 0-57.664646 26.763636-57.664646 59.733333 0 32.969697 25.858586 59.733333 57.664646 59.733334s57.664646-26.763636 57.664647-59.733334c-0.129293-33.09899-25.858586-59.733333-57.664647-59.733333z m115.2-270.222222H166.335354c-63.612121 0-115.2 53.527273-115.2 119.59596v390.981818c0 65.939394 52.751515 126.836364 117.785858 126.836363h175.579798c30.513131 32.581818 157.220202 149.979798 157.220202 149.979798 5.559596 5.818182 14.739394 5.818182 20.29899 0 0 0 92.832323-91.410101 153.212121-149.979798h179.717172c65.034343 0 117.785859-60.89697 117.785859-126.836363V236.606061c0.129293-65.939394-51.458586-119.466667-115.070708-119.466667z m57.535354 510.577778c0 32.969697-27.668687 67.620202-60.250505 67.620202H678.335354c-21.462626 0-40.727273 21.979798-40.727273 21.979798l-124.121212 114.941414-124.121212-114.941414s-23.660606-21.979798-43.830303-21.979798H168.921212c-32.581818 0-60.250505-34.650505-60.250505-67.620202V236.606061c0-32.969697 25.729293-59.733333 57.664647-59.733334h691.329292c31.806061 0 57.535354 26.763636 57.535354 59.733334v391.111111z m0 0"></path></svg>
                                    <!-- è¯„è®ºæŒ‰é’®æ–‡å­— -->
                                    <span class="comment-text">è¯„è®º ({{ .Params.comments_count | default "0" }})</span> 
                                </button>
                                {{ end }}
                            </div>

                            <!-- è¯„è®ºå®¹å™¨ï¼šç‚¹å‡»æŒ‰é’®åä¼šåœ¨è¿™é‡Œæ¸²æŸ“ Waline è¯„è®º -->
                            <div
                                class="waline-container"
                                id="waline-{{ .Param "slug" }}"
                                data-path="{{ .Param "slug" }}"
                            ></div>
                        </div>
                    {{ end }}
                {{ end }}
            </div>
        </div>
    </article>

    <!-- JavaScript ä»£ç  -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // å›¾ç‰‡æ‡’åŠ è½½å’Œé¢„åŠ è½½å¤„ç†
            const imageObserver = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        const wrapper = img.closest('.moment-content-wrapper');
                        const loadingEl = wrapper.nextElementSibling;
                        const errorEl = loadingEl.nextElementSibling;

                        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                        loadingEl.style.display = 'flex';
                        errorEl.style.display = 'none';

                        // åˆ›å»ºæ–°çš„Imageå¯¹è±¡ç”¨äºé¢„åŠ è½½
                        const tempImg = new Image();
                        tempImg.onload = function() {
                            img.src = img.dataset.src;
                            img.classList.add('loaded');
                            loadingEl.style.display = 'none';
                            observer.unobserve(img);
                        };
                        tempImg.onerror = function() {
                            loadingEl.style.display = 'none';
                            errorEl.style.display = 'block';
                        };
                        tempImg.src = img.dataset.src;
                    }
                });
            }, {
                rootMargin: '50px 0px',
                threshold: 0.1
            });

            // å¤„ç†æ‰€æœ‰å›¾ç‰‡å…ƒç´ 
            document.querySelectorAll('.moment-content-wrapper').forEach(wrapper => {
                const loadingEl = wrapper.nextElementSibling;
                const images = wrapper.querySelectorAll('img');
                
                if (images.length === 0) {
                    loadingEl.style.display = 'none';
                    return;
                }

                let loadedImages = 0;
                images.forEach(img => {
                    if (img.src) {
                        img.dataset.src = img.src;
                        img.src = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7'; // é€æ˜å ä½å›¾
                        imageObserver.observe(img);
                        
                        // ç›‘å¬å›¾ç‰‡åŠ è½½å®Œæˆ
                        img.onload = () => {
                            loadedImages++;
                            if (loadedImages === images.length) {
                                loadingEl.style.display = 'none';
                            }
                        };
                    }
                });
            });

            // é‡è¯•åŠ è½½åŠŸèƒ½
            window.retryLoad = function(button) {
                const errorEl = button.closest('.moment-error');
                const loadingEl = errorEl.previousElementSibling;
                const wrapper = loadingEl.previousElementSibling;
                const img = wrapper.querySelector('img');

                errorEl.style.display = 'none';
                loadingEl.style.display = 'flex';

                const tempImg = new Image();
                tempImg.onload = function() {
                    img.src = img.dataset.src;
                    img.classList.add('loaded');
                    loadingEl.style.display = 'none';
                };
                tempImg.onerror = function() {
                    loadingEl.style.display = 'none';
                    errorEl.style.display = 'block';
                };
                tempImg.src = img.dataset.src;
            };

            // æ–°å¢åˆ†é¡µç›¸å…³å˜é‡
            let currentPage = 1;
            const pageSize = {{ .Site.Params.moments.pageSize | default 8 }};
            let filteredMoments = [];
            let isLoading = false;
            let isAllLoaded = false;
            let loadingTimeout = null;
            const loadingHint = document.createElement('div');
            loadingHint.className = 'scroll-hint-container';
            loadingHint.innerHTML = '<div class="loading-hint">åŠ è½½æ›´å¤š...</div>';
            document.querySelector('.moments-list').after(loadingHint);

            // æ˜¾ç¤ºåˆ†é¡µå†…å®¹çš„æ–¹æ³•
            function displayMoments() {
                const end = currentPage * pageSize;
                const totalItems = filteredMoments.length;
                
                // ä¼˜åŒ–æ˜¾ç¤ºé€»è¾‘ï¼Œåªå¤„ç†æ–°å¢çš„å†…å®¹
                const start = (currentPage - 1) * pageSize;
                filteredMoments.slice(start, end).forEach(moment => {
                    moment.style.display = 'block';
                    // è§¦å‘å›¾ç‰‡æ‡’åŠ è½½é‡æ–°æ£€æŸ¥
                    moment.querySelectorAll('img[data-src]').forEach(img => {
                        imageObserver.observe(img);
                    });
                });

                // æ›´æ–°åº•éƒ¨æç¤º
                const hasMore = end < totalItems;
                isAllLoaded = !hasMore;
                
                if (totalItems === 0) {
                    loadingHint.innerHTML = '<div class="end-divider">æš‚æ— å†…å®¹</div>';
                } else if (isAllLoaded) {
                    loadingHint.innerHTML = '<div class="end-divider">â€”â€”â€”â€” Â· å·²åˆ°åº•éƒ¨ Â· â€”â€”â€”â€”</div>';
                } else {
                    loadingHint.innerHTML = '<div class="loading-hint">åŠ è½½æ›´å¤š...</div>';
                }
                loadingHint.style.display = 'block';
            }

            // ä¼˜åŒ–çš„æ»šåŠ¨äº‹ä»¶å¤„ç†
            function checkScroll() {
                if (isLoading || isAllLoaded || filteredMoments.length === 0) return;
                
                const { scrollTop, scrollHeight, clientHeight } = document.documentElement;
                const threshold = 200; // å¢åŠ é˜ˆå€¼ï¼Œæå‰å¼€å§‹åŠ è½½
                const end = currentPage * pageSize;
                
                if (end < filteredMoments.length && scrollTop + clientHeight >= scrollHeight - threshold) {
                    isLoading = true;
                    loadingHint.innerHTML = '<div class="loading-hint"><div class="loading-spinner"></div>åŠ è½½ä¸­...</div>';
                    
                    // æ¸…é™¤ä¹‹å‰çš„è¶…æ—¶
                    if (loadingTimeout) {
                        clearTimeout(loadingTimeout);
                    }
                    
                    // ä½¿ç”¨ requestAnimationFrame å’Œé˜²æŠ–ä¼˜åŒ–æ€§èƒ½
                    requestAnimationFrame(() => {
                        loadingTimeout = setTimeout(() => {
                            currentPage++;
                            displayMoments();
                            isLoading = false;
                            loadingTimeout = null;
                        }, 300);
                    });
                }
            }

            // ç‚¹å‡»æ ‡ç­¾æ—¶ç­›é€‰é€»è¾‘
            const tags = document.querySelectorAll('.tag-filter');  // è·å–æ‰€æœ‰æ ‡ç­¾
            const moments = document.querySelectorAll('.moment-card');  // è·å–æ‰€æœ‰ moment å¡ç‰‡
            const allTags = document.querySelector('.all-tags');  // è·å–"å…¨éƒ¨"æŒ‰é’®
            const momentTags = document.querySelectorAll('.moment-tag'); // è·å–æ‰€æœ‰å¡ç‰‡å†…çš„æ ‡ç­¾

            // é»˜è®¤é€‰ä¸­"å…¨éƒ¨"æ ‡ç­¾
            if (allTags) {
                allTags.classList.add('selected');
            }

            // ç‚¹å‡»æ ‡ç­¾æ—¶è¿›è¡Œç­›é€‰
            tags.forEach(tag => {
                tag.addEventListener('click', function(e) {
                    e.preventDefault();
                    const selectedTag = tag.textContent.trim();
                    
                    filteredMoments = Array.from(moments).filter(moment => {
                        const momentTags = moment.querySelectorAll('.moment-tag');
                        return selectedTag === 'å…¨éƒ¨' || 
                            Array.from(momentTags).some(t => t.textContent === selectedTag);
                    });

                    currentPage = 1;
                    displayMoments();
                    window.scrollTo(0, 0); // ç­›é€‰åå›åˆ°é¡¶éƒ¨
                    
                    tags.forEach(t => t.classList.remove('selected'));
                    tag.classList.add('selected');
                });
            });

            // ä¸ºå¡ç‰‡å†…çš„æ ‡ç­¾æ·»åŠ ç‚¹å‡»äº‹ä»¶
            momentTags.forEach(tag => {
                tag.style.cursor = 'pointer';
                tag.addEventListener('click', function() {
                    const tagText = this.textContent.trim();
                    // æ‰¾åˆ°å¯¹åº”çš„é¡¶éƒ¨æ ‡ç­¾å¹¶è§¦å‘ç‚¹å‡»
                    tags.forEach(headerTag => {
                        if (headerTag.textContent.trim() === tagText) {
                            headerTag.click();
                        }
                    });
                });
            });

            // åˆå§‹åŠ è½½
            filteredMoments = Array.from(moments);
            displayMoments();
            // ç¡®ä¿æç¤ºå®¹å™¨æ­£ç¡®æ’å…¥
            const existingHint = document.querySelector('.scroll-hint-container');
            if (!existingHint) {
                const hintContainer = document.createElement('div');
                hintContainer.className = 'scroll-hint-container';
                document.querySelector('.moments-list').after(hintContainer);
            }
            window.addEventListener('scroll', checkScroll);
        });
    </script>

    <!-- åœ¨é¡µé¢åº•éƒ¨å¼•å…¥ Waline è¯„è®ºè„šæœ¬å¹¶åˆå§‹åŒ– -->
    <script type="module">
        import { init } from 'https://unpkg.com/@waline/client@v3/dist/waline.js';
        
        const walineParams = {
            /* è¿™é‡Œæ ¹æ®ä½ è‡ªå·±çš„ Waline é…ç½®è¿›è¡Œè°ƒæ•´ */
            serverURL: '{{ .Site.Params.waline.serverURL }}',
            lang: '{{ .Site.Params.waline.lang | default "zh-CN" }}',
            visitor: '{{ .Site.Params.waline.visitor | default "åŒ¿åè€…" }}',
            emoji: [
                {{- range .Site.Params.waline.emoji }}
                    '{{ . }}',
                {{- end }}
            ],
            requiredMeta: [
                {{- range .Site.Params.waline.requiredMeta }}
                    '{{ . }}',
                {{- end }}
            ],
            locale: {
                admin: '{{ .Site.Params.waline.locale.admin | default "ä½œè€…æœ¬äºº" }}',
                placeholder: '{{ .Site.Params.waline.locale.placeholder | default "ğŸ—æ‰€ä»¥æˆ‘é…æœ‰ä¸€æ¡è¯„è®ºå—ï¼" }}',
            },
            dark: '{{ .Site.Params.waline.dark | default "html.dark" }}',
        };
        
        // ç‚¹å‡»"æ·»åŠ è¯„è®º"æŒ‰é’®æ—¶ï¼Œæ˜¾ç¤ºå¯¹åº”å¡ç‰‡ä¸‹çš„è¯„è®ºåŒº
        window.showComment = function(element) {
            const slug = element.getAttribute('data-slug');
            const path = element.getAttribute('data-path');
            const commentElement = document.getElementById('waline-' + slug);

            // å¦‚æœå·²æ¿€æ´»åˆ™æ¸…ç©º
            if (commentElement.classList.contains('active')) {
                commentElement.classList.remove('active');
                commentElement.innerHTML = '';
                return;
            }

            // ç§»é™¤å…¶å®ƒæ‰€æœ‰å·²æ¿€æ´»è¯„è®ºåŒº
            const allComments = document.querySelectorAll('.waline-container');
            allComments.forEach(el => {
                el.classList.remove('active');
                el.innerHTML = '';
            });

            // æ¿€æ´»å½“å‰è¯„è®ºåŒº
            commentElement.classList.add('active');

            // åˆå§‹åŒ– Waline
            init({
                el: commentElement,
                serverURL: walineParams.serverURL,
                lang: walineParams.lang,
                visitor: walineParams.visitor,
                emoji: walineParams.emoji,
                requiredMeta: walineParams.requiredMeta,
                locale: walineParams.locale,
                path: path,
                dark: walineParams.dark,
            });
        }
    </script>

    <!-- è·å–è¯„è®ºæ•° -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // è·å–æ‰€æœ‰è¯„è®ºæŒ‰é’®
            const commentBtns = document.querySelectorAll('.moment-comment-btn');

            // ç¡®ä¿æœ‰æ‰¾åˆ°è¯„è®ºæŒ‰é’®
            if (commentBtns.length > 0) {
                commentBtns.forEach(button => {
                    const slug = button.getAttribute('data-slug');  // è·å–æŒ‰é’®å¯¹åº”çš„ slug
                    const commentText = button.querySelector('.comment-text');  // è·å–æŒ‰é’®ä¸­çš„è¯„è®ºæ–‡æœ¬
                    const serverURL = '{{ .Site.Params.waline.serverURL }}';  // è·å– Waline æœåŠ¡å™¨åœ°å€

                    // è¾“å‡ºè°ƒè¯•ä¿¡æ¯ï¼ŒæŸ¥çœ‹æ˜¯å¦æœ‰å¤šä¸ªæŒ‰é’®
                    console.log(`Processing button with slug: ${slug}`);

                    if (slug && commentText) {
                        // å‡è®¾ä½ æœ‰ä¸€ä¸ªè·å–è¯„è®ºæ•°é‡çš„ API æˆ–æ¥å£
                        fetch(`${serverURL}/api/comment?type=count&url=${slug}`)
                            .then(response => response.json())
                            .then(data => {
                                if (commentText) {
                                    // ä» API è¿”å›çš„æ•°æ®ä¸­æå–è¯„è®ºæ•°
                                    const commentCount = data.data && data.data[0] ? data.data[0] : 0;  // å¦‚æœæ²¡æœ‰æ•°æ®æˆ–è¯„è®ºæ•°ï¼Œé»˜è®¤ä¸º 0
                                    
                                    // è¾“å‡ºè°ƒè¯•ä¿¡æ¯ï¼ŒæŸ¥çœ‹è¯„è®ºæ•°
                                    console.log(`Fetched comment count: ${commentCount}`);

                                    // æ›´æ–°è¯„è®ºæŒ‰é’®ä¸Šçš„è¯„è®ºæ•°é‡
                                    commentText.textContent = `è¯„è®º (${commentCount})`;  // æ›´æ–°è¯„è®ºæ•°
                                }
                            })
                            .catch(error => {
                                console.error('Error fetching comment count:', error);
                                if (commentText) {
                                    // å¦‚æœ API è¯·æ±‚å¤±è´¥ï¼Œä¿æŒè¯„è®ºæ•°ä¸º 0
                                    commentText.textContent = `è¯„è®º (0)`;
                                }
                            });
                    } else {
                        console.error('Slug or commentText missing for button:', button);
                    }
                });
            } else {
                console.error('No comment buttons found');
            }
        });
    </script>

{{ end }}
